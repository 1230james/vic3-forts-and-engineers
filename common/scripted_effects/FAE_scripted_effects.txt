# Root: Battle
# Set a local variable named `total_siege` before calling
# `SCOPE` should be either `attacker` or `character` depending on if it's being called from the on_battle_started OA or
# for a battle condition, respectively
FAE_se_calculate_siege = {
    every_combat_unit = {
        save_scope_as = current_unit
        
        # Only consider troops controlled by the specified character
        # Check for that by checking if the troops belong to the same nation or an ally of the nation owned by the
        # character
        limit = {
            OR = {
                owner = scope:$SCOPE$.owner
                owner = {
                    is_in_war_together = scope:$SCOPE$.owner
                }
            }
        }
        
        # Add siege from combat engineers
        if = {
            limit = {
                owner = {
                    any_military_formation = {
                        has_mobilization_option = mobilization_option:FAE_mo_combat_engineers
                        any_combat_unit = {
                            this = scope:current_unit
                        }
                    }
                }
            }
            change_local_variable = {
                name = total_siege
                add  = FAE_siege_combat_engies
            }
        }
        
        # Add siege from unit type
        if = {
            limit = {
                has_unit_type = unit_type:combat_unit_type_light_tanks
            }
            change_local_variable = {
                name = total_siege
                add  = FAE_siege_light_tank
            }
        }
        else_if = {
            limit = {
                has_unit_type = unit_type:combat_unit_type_heavy_tank
            }
            change_local_variable = {
                name = total_siege
                add  = FAE_siege_heavy_tank
            }
        }
        else_if = {
            limit = {
                has_unit_type = unit_type:combat_unit_type_siege_artillery
            }
            change_local_variable = {
                name = total_siege
                add  = FAE_siege_siege_arty
            }
        }
        else_if = {
            limit = {
                has_unit_type = unit_type:combat_unit_type_shrapnel_artillery
            }
            change_local_variable = {
                name = total_siege
                add  = FAE_siege_shrapnel_arty
            }
        }
        else_if = {
            limit = {
                has_unit_type = unit_type:combat_unit_type_mobile_artillery
            }
            change_local_variable = {
                name = total_siege
                add  = FAE_siege_mobile_arty
            }
        }
        else_if = {
            limit = {
                has_unit_type = unit_type:combat_unit_type_cannon_artillery
            }
            change_local_variable = {
                name = total_siege
                add  = FAE_siege_cannon_arty
            }
        }
    }
}
